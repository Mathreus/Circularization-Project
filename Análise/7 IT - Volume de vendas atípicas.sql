SELECT
    COD_ESTABELECIMENTO,
    
    -- Cálculo de vendas totais:
    SUM(CASE 
            WHEN CFOP IN ('5.101', '5.102', '5.103', '5.104', '5.105', '5.106', '5.107', '5.108', '5.109', 
                         '5.110', '5.111', '5.112', '5.113', '5.114', '5.115', '5.116', '5.201', '5.202',
                         '5.203', '5.204', '5.205', '5.206', '5.207', '5.208', '5.209', '5.401', '5.402',
                         '5.403', '5.404', '5.405', '5.501', '5.502', '5.503', '5.504', '6.101', '6.102',
                         '6.103', '6.104', '6.105', '6.106', '6.107', '6.108', '6.109', '6.110', '6.111',
                         '6.112', '6.113', '6.114', '6.115', '6.116') THEN VALOR 
            ELSE 0 
        END) AS VALOR_VENDAS,

    -- Cálculo de vendas em finais de semana:    
    SUM(
        CASE 
            WHEN DATEPART(WEEKDAY, DATA_NOTA_FISCAL) IN (1, 7)  -- É final de semana
            AND CFOP IN ('5.101', '5.102', '5.103', '5.104', '5.105', '5.106', '5.107', '5.108', '5.109', 
                         '5.110', '5.111', '5.112', '5.113', '5.114', '5.115', '5.116', '5.201', '5.202',
                         '5.203', '5.204', '5.205', '5.206', '5.207', '5.208', '5.209', '5.401', '5.402',
                         '5.403', '5.404', '5.405', '5.501', '5.502', '5.503', '5.504', '6.101', '6.102',
                         '6.103', '6.104', '6.105', '6.106', '6.107', '6.108', '6.109', '6.110', '6.111',
                         '6.112', '6.113', '6.114', '6.115', '6.116') THEN VALOR  -- Corrigido: era FDS
            ELSE 0 
        END) AS VENDAS_FINAIS_SEMANA,
    
    -- Índice: VENDAS_FINAIS_SEMANA / VALOR_VENDAS em PERCENTUAL (%)
    CASE 
        WHEN SUM(CASE 
                    WHEN CFOP IN ('5.101', '5.102', '5.103', '5.104', '5.105', '5.106', '5.107', '5.108', '5.109', 
                                 '5.110', '5.111', '5.112', '5.113', '5.114', '5.115', '5.116', '5.201', '5.202',
                                 '5.203', '5.204', '5.205', '5.206', '5.207', '5.208', '5.209', '5.401', '5.402',
                                 '5.403', '5.404', '5.405', '5.501', '5.502', '5.503', '5.504', '6.101', '6.102',
                                 '6.103', '6.104', '6.105', '6.106', '6.107', '6.108', '6.109', '6.110', '6.111',
                                 '6.112', '6.113', '6.114', '6.115', '6.116') THEN VALOR 
                    ELSE 0 
                END) > 0  -- Evita divisão por zero
        THEN 
            (SUM(
                CASE 
                    WHEN DATEPART(WEEKDAY, DATA_NOTA_FISCAL) IN (1, 7)
                    AND CFOP IN ('5.101', '5.102', '5.103', '5.104', '5.105', '5.106', '5.107', '5.108', '5.109', 
                                 '5.110', '5.111', '5.112', '5.113', '5.114', '5.115', '5.116', '5.201', '5.202',
                                 '5.203', '5.204', '5.205', '5.206', '5.207', '5.208', '5.209', '5.401', '5.402',
                                 '5.403', '5.404', '5.405', '5.501', '5.502', '5.503', '5.504', '6.101', '6.102',
                                 '6.103', '6.104', '6.105', '6.106', '6.107', '6.108', '6.109', '6.110', '6.111',
                                 '6.112', '6.113', '6.114', '6.115', '6.116') THEN VALOR  -- Corrigido: era FDS
                    ELSE 0 
                END
            ) * 100.0) /  
            SUM(CASE 
                    WHEN CFOP IN ('5.101', '5.102', '5.103', '5.104', '5.105', '5.106', '5.107', '5.108', '5.109', 
                                 '5.110', '5.111', '5.112', '5.113', '5.114', '5.115', '5.116', '5.201', '5.202',
                                 '5.203', '5.204', '5.205', '5.206', '5.207', '5.208', '5.209', '5.401', '5.402',
                                 '5.403', '5.404', '5.405', '5.501', '5.502', '5.503', '5.504', '6.101', '6.102',
                                 '6.103', '6.104', '6.105', '6.106', '6.107', '6.108', '6.109', '6.110', '6.111',
                                 '6.112', '6.113', '6.114', '6.115', '6.116') THEN VALOR 
                    ELSE 0 
                END)
        ELSE 0 
    END AS INDICE_VENDAS_ATIPICAS
FROM 
    VW_AUDIT_RM_ORDENS_VENDA
WHERE 
    COD_ESTABELECIMENTO = 'R281'
    AND DATA_NOTA_FISCAL BETWEEN '2025-12-01' AND '2025-12-31'  
GROUP BY 
    COD_ESTABELECIMENTO
ORDER BY 
    COD_ESTABELECIMENTO;
